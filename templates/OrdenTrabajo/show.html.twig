{% extends '@EasyAdmin/default/show.html.twig' %}

{% block content_title %}
    {{parent()}}
    <a class="btn btn-success exportOt" style="float:right;" href="javascript:;" data-toggle="modal" data-target=".bs-example-modal-sm" target="_self" data-id="{{entity.id}}"><i class="fa fa-download"></i>&nbsp;Exportar</a>
{% endblock %}

{% block main %}
    {{ parent() }}
    <!-- Exportar modal -->
    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
      <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-header" style="background-color:#f05536;">
            <h4 class="modal-title" id="myModalLabel" style="color:white;">Exportar - Seleccionar formato</h4>
            <button type="button" class="close" style="float:right" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
       <div class="modal-body">
          <form id="formExportar1" action="{{ path('easyadmin', {entity: 'OrdenTrabajo', action: 'exportar', filters: app.request.get('filters') }) }}" method="POST">
            <input type="hidden" name="ordenes_trabajo" id="ordenes_trabajo" value="2" >
            <div class="radio">
              <label>
                <input type="radio" name="formato" id="formato" value="WORD" checked>
                WORD
              </label><br>
              <label>
                <input type="radio" name="formato" id="formato" value="PDF" >
                PDF
              </label><br>
              <label>
                <input type="radio" name="formato" id="formato" value="EXCEL" >
                EXCEL
              </label>
              <label>
                <input type="radio" name="formato" id="formato" value="ORDENESEXCEL">
                LISTADO DE ÓRDENES EXCEL
              </label>
              <label>
                <input type="radio" name="formato" id="formato" value="ALLORDENESEXCEL">
                LISTADO DE ÓRDENES EXCEL (toda la lista filtrada)
              </label>
            </div>
          </form>
          </div>  
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
               <button id="btnExportar" type="button" class="btn btn-primary" onclick="exportar()">Exportar</button>
            </div>
        </div>
      </div>
    </div>
    {% import _self as render %}
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */        
        .map{
            height: 250px;
        }
    </style>
    {# Aca se muestran los mapas de recibido y cierre #}
    {% if entity.latitud is not empty %}
        <p><strong> Ubicación Recibido </strong></p>
        <div id="mapRecibido" class="map"></div>
        <p><strong> Ubicación Cierre </strong></p>
        <div id="mapCierre" class="map"></div>
    {% endif %}
    {% if entity.formularioResultado is not null %}
    <hr>
    {% set analisisInciencia = entity.obtenerIncidencias() %}
    {% if analisisInciencia['incidenciasTotal'] > 0 %}
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">
                {{ 'formulario_resultado_incidencias_encontradas'|trans({'encontradas': analisisInciencia['incidenciasEncontradas']|length}) }} 
                {{ analisisInciencia['incidenciasEncontradas']|length ~ '/' ~ analisisInciencia['incidenciasTotal']}}
            </h5>
            <table class="table table-sm table-bordered">
                <tbody>
                    {% for incidencia in analisisInciencia['incidenciasEncontradas'] %}
                    <tr>
                        <th>{{ incidencia.item }}</th>
                        <td>{{ (incidencia.opciones is defined) ? incidencia.opciones : 'ningun_valor'|trans }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Formulario</h5>
            <div>
                {% if entity.formularioResultado is null %}
                    <p> No tiene {{ 'modulos'|trans }} </p>
                {% else %}
                    {# Recorro modulos #}
                    {% set resultados = entity.mergeResultadoFormulario() %}
                    {% set modulosRepetido = [] %}
                    {% set paginaNombre = null %}
                    {% set paginaNumero = null %}
                    {% set mostrarPaginaNombre = false %}

                    {% for key, pm in entity.formulario.propiedadModulos %}
                        {% if pm.pagina != paginaNumero %}
                            {% set paginaNumero = pm.pagina %}
                            {% set paginaNombre = pm.paginaNombre %}
                            {% set mostrarPaginaNombre = true %}

                        {% endif %}

                        {% set modulosRepetido = entity.arrayIndiceModulo(modulosRepetido, pm.modulo.id)%}

                        {% if resultados[pm.modulo.id][modulosRepetido[pm.modulo.id]] is defined and
                            resultados[pm.modulo.id][modulosRepetido[pm.modulo.id]]|length > 0 %}
                            {% if mostrarPaginaNombre == true %}
                                <h6 class="card-subtitle">{{ paginaNombre }}</h6>
                                {% set mostrarPaginaNombre = false %}
                            {% endif %}
                            {% if pm.equipo %}
                                <h6 class="card-subtitle" style="margin-top: 5px; color: chocolate;"><strong>Equipo: {{ pm.equipo }}</strong></h6>
                            {% endif %}
                            <h6>{{ pm.modulo.titulo }}</h6>

                            {{ render.renderModulo(pm, resultados[pm.modulo.id][modulosRepetido[pm.modulo.id]]) }}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    {% macro renderModulo(propiedadModulo, propiedadItems) %}
        {% import _self as render %}
        <table class="table table-bordered">
            <tbody>
                {# Recorro los item del modulo #}
                {% for pi in propiedadModulo.modulo.propiedadItems %}
                    {% if propiedadItems[pi.id] is defined %}
                        {{render.renderItem(pi.item, propiedadItems[pi.id])}}
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <br>
    {% endmacro %}
    {% block entity_form %} 
    {% macro renderItem(item, propiedadItemsResultado) %}
       
            {% if item.tipo == 'foto' %}
                {% for k, r in propiedadItemsResultado %}
                    {% if r.imageName is not empty %}
                        {% if k == 0%}
                            <tr>
                                <td colspan="2">
                                    {{  item.titulo }}<br>
                        {% endif %}
                                <a target="_blank" class="example-image-link" href="{{vich_uploader_asset(r, 'imageFile')}}" data-lightbox="example-set">
                                    <img class="example-image" src="{{vich_uploader_asset(r, 'imageFile')}}" alt=""  width="150" height="200"/>
                                </a>
                        {% if k == propiedadItemsResultado|length - 1%}
                            </td>
                        </tr>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% elseif item.tipo == 'titulo' %}
                <td colspan="2">{{ item.titulo }}</td>
            {% else %}
                {% set resArray = [] %}
                {% for r in propiedadItemsResultado %}
                    {% set resArray = resArray|merge([r.obtenerValorToString()]) %}
                {% endfor %}
                {% set texto = resArray|join('|') %}
                
                {% if texto is not empty %}
                    <tr>
                        <td>{{ item.titulo ~ ':' }}</td>
                        {% if item.tipo == 'texto' %}
                        <td align="center"><input type="text" value="{{ texto|trim }}"></input></td>
                        {% else %}
                        <td align="center">{{ texto|trim  }}</td>
                        {% endif %}
                    </tr>
                {% endif %}
            {% endif %}
        {% endmacro %}
        <button class=" btn btn-primary btn-lg action-save" style="float:right" onclick="guardar()">Guardar</button>
    {% endblock entity_form %}
{% endblock %}

{% block body_javascript %}
    {{ parent() }}

    <script>
        
        $(".exportOt").click(function(){
            $("#orden_trabajo").val($(this).data('id'));
            $("#ordenes_trabajo").val($(this).data('id'));
        });

    function exportar(){
      $("#formExportar1").submit();
    };
        //Mapa Recibido
        var map;
        var myLatLng = {lat: {{entity.latitud|default(0)}}, lng: {{entity.longitud|default(0)}}};
        //Mapa Cierre
        var mapCierre; // creo que no cumple funcion, esta de adorno
        var myLatLngCierre = {lat: {{entity.latitudCierre|default(0)}}, lng: {{entity.longitudCierre|default(0)}}};

        function initMap() {
            map = new google.maps.Map(document.getElementById('mapRecibido'), {
                zoom: 17,
                center: myLatLng
            });

            var marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                title: 'Orden de trabajo'
            });

            map2 = new google.maps.Map(document.getElementById('mapCierre'), {
                zoom: 17,
                center: myLatLngCierre
            });

            var marker = new google.maps.Marker({
                position: myLatLngCierre,
                map: map2,
                title: 'Orden de trabajo'
            });
        }

        
        
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{googleKeyApi}}&callback=initMap"
    async defer></script>
    
        

{% endblock %}
